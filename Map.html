<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Release Window Map</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <!-- ReSharper disable Html.PathError -->
    <script src="scripts/d3.min.js"></script>
    <script src="scripts/topojson.min.js"></script>
    <script src="scripts/datamaps.world.hires.min.js"></script>
    <script src="scripts/moment.js"></script>
    <script src="scripts/moment-timezone-with-data.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #131313;
            font-family: "Lucida Console", Monaco, monospace;
            overflow-x: hidden;
            overflow-y: hidden;
        }

        div.info {
            position: absolute;
            padding: 4px 6px;
            left: 5%;
            top: 80%;
            display: flex;
            /* ReSharper disable once CssBrowserCompatibility */
            flex-wrap: wrap;
            background-color: rgba(80, 80, 80, 0.31);
        }

        div.country {
            color: #00e800;
            /* ReSharper disable once InvalidValue */
            display: flexbox;
            margin-right: 20px;
        }

            div.country:last-child {
                margin-right: 10px;
            }

        div#container {
            width: 100%;
            height: 100vh;
        }

        div#time {
            position: absolute;
            top: 0;
            height: 100vh;
            width: 2px;
            background-color: #ffc300;
            opacity: 0.4;
        }

        div#beer {
            position: absolute;
            top: 0;
            height: 100vh;
            width: 2px;
            background-color: #009900;
            opacity: 0.4;
        }

        div#alarm {
            position: absolute;
            top: 0;
            height: 100vh;
            width: 2px;
            background-color: #a00000;
            opacity: 0.4;
        }

        div#scan {
            position: absolute;
            left: 0;
            width: 100vw;
            height: 1px;
            background-color: #19a7e9;
            opacity: 0.2;
        }

        pre {
            margin: 0;
            font-size: large;
        }

        .legend {
            position: absolute;
            left: 5%;
            top: 60%;
            background-color: rgba(80, 80, 80, 0.31);
            padding: 4px 20px;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="time"></div>
    <div id="beer"></div>
    <div id="alarm"></div>
    <div id="scan"></div>
    <div class="info" id="info"></div>
    <div class="legend">
        <pre><span style="color: #ffc300">&#xff0d;</span> <span style="color: #19a7e9">High noon</span>
<span style="color: #009900">&#xff0d;</span> <span style="color: #19a7e9">Beer o'clock</span>
<span style="color: #a00000">&#xff0d;</span> <span style="color: #19a7e9">Bloody alarm o'clock</span></pre>
    </div>
    <script>
        var countries = ['AUS', 'DNK', 'ESP', 'FRA', 'GBR', 'IRL', 'ITA', 'NOR', 'NZL'];

        var windows = [
            [
                // Sunday
            ],
            [
                // Monday
                {
                    start: '07:00',
                    end: '14:00',
                    country: 'GBR'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'ESP'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'ESP'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'DNK'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'DNK'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'IRL'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'IRL'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'FRA'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'FRA'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'NOR'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'NOR'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'ITA'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'ITA'
                },
                {
                    start: '04:00',
                    end: '06:00',
                    country: 'AUS'
                },
                {
                    start: '04:00',
                    end: '06:00',
                    country: 'NZL'
                },
                {
                    start: '13:00',
                    end: '23:59',
                    country: 'AUS'
                },
                {
                    start: '13:00',
                    end: '23:59',
                    country: 'NZL'
                }
            ],
            [
                // Tuesday
                {
                    start: '07:00',
                    end: '14:00',
                    country: 'GBR'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'ESP'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'ESP'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'DNK'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'DNK'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'IRL'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'IRL'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'FRA'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'FRA'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'NOR'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'NOR'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'ITA'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'ITA'
                },
                {
                    start: '04:00',
                    end: '06:00',
                    country: 'AUS'
                },
                {
                    start: '04:00',
                    end: '06:00',
                    country: 'NZL'
                },
                {
                    start: '13:00',
                    end: '23:59',
                    country: 'AUS'
                },
                {
                    start: '13:00',
                    end: '23:59',
                    country: 'NZL'
                },
                {
                    start: '00:00',
                    end: '02:00',
                    country: 'AUS'
                },
                {
                    start: '00:00',
                    end: '02:00',
                    country: 'NZL'
                }
            ],
            [
                // Wednesday
                {
                    start: '07:00',
                    end: '14:00',
                    country: 'GBR'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'ESP'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'ESP'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'DNK'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'DNK'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'IRL'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'IRL'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'FRA'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'FRA'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'NOR'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'NOR'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'ITA'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'ITA'
                },
                {
                    start: '04:00',
                    end: '06:00',
                    country: 'AUS'
                },
                {
                    start: '04:00',
                    end: '06:00',
                    country: 'NZL'
                },
                {
                    start: '13:00',
                    end: '23:59',
                    country: 'AUS'
                },
                {
                    start: '13:00',
                    end: '23:59',
                    country: 'NZL'
                },
                {
                    start: '00:00',
                    end: '02:00',
                    country: 'AUS'
                },
                {
                    start: '00:00',
                    end: '02:00',
                    country: 'NZL'
                }
            ],
            [
                // Thursday
                {
                    start: '07:00',
                    end: '14:00',
                    country: 'GBR'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'ESP'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'ESP'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'DNK'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'DNK'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'IRL'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'IRL'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'FRA'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'FRA'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'NOR'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'NOR'
                },
                {
                    start: '07:00',
                    end: '12:00',
                    country: 'ITA'
                },
                {
                    start: '15:00',
                    end: '16:00',
                    country: 'ITA'
                },
                {
                    start: '00:00',
                    end: '02:00',
                    country: 'AUS'
                },
                {
                    start: '00:00',
                    end: '02:00',
                    country: 'NZL'
                },
                {
                    start: '06:00',
                    end: '08:00',
                    country: 'AUS'
                },
                {
                    start: '06:00',
                    end: '08:00',
                    country: 'NZL'
                },
                {
                    start: '13:00',
                    end: '15:00',
                    country: 'AUS'
                },
                {
                    start: '13:00',
                    end: '15:00',
                    country: 'NZL'
                }
            ],
            [
                // Friday
            ],
            [
                // Saturday
            ]
        ];

        var offices = [
            {
                // UK - Bristol
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 51.4516607,
                longitude: -2.599413,
                borderWidth: 0
            },
            {
                // UK - London
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 51.516321,
                longitude: -0.1052626,
                borderWidth: 0
            },
            {
                // UK - Borehamwood
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 51.6582636,
                longitude: -0.2702409,
                borderWidth: 0
            },
            {
                // Ireland
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 53.3187668,
                longitude: -6.2158948,
                borderWidth: 0
            },
            {
                // France
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 48.832653,
                longitude: 2.2745108,
                borderWidth: 0
            },
            {
                // Spain
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 40.444133,
                longitude: -3.6581953,
                borderWidth: 0
            },
            {
                // Italy
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 45.4725795,
                longitude: 9.1571298,
                borderWidth: 0
            },
            {
                // Denmark - Copenhagen
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 55.7087167,
                longitude: 12.5602227,
                borderWidth: 0
            },
            {
                // Denmark - Aarhus
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 56.1389854,
                longitude: 10.1699192,
                borderWidth: 0
            },
            {
                // Switzerland
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 47.3725304,
                longitude: 8.5279722,
                borderWidth: 0
            },
            {
                // Norway
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 59.8939529,
                longitude: 10.6450359,
                borderWidth: 0
            },
            {
                // Australia - Sydney
                radius: 2,
                fillKey: 'OFFICE',
                latitude: -33.8708419,
                longitude: 151.2051413,
                borderWidth: 0
            },
            {
                // Australia - Mount Waverly
                radius: 2,
                fillKey: 'OFFICE',
                latitude: -37.8772826,
                longitude: 145.124359,
                borderWidth: 0
            },
            {
                // New Zealand
                radius: 2,
                fillKey: 'OFFICE',
                latitude: -36.8621369,
                longitude: 174.7372029,
                borderWidth: 0
            },
            {
                // Brazil
                radius: 2,
                fillKey: 'OFFICE',
                latitude: -23.5432253,
                longitude: -46.7357653,
                borderWidth: 0
            },
            {
                // Canada - Toronto
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 43.6462565,
                longitude: -79.3984558,
                borderWidth: 0
            },
            {
                // Canada - Winnipeg
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 49.8983662,
                longitude: -97.1461043,
                borderWidth: 0
            },
            {
                // Canada - Winnipeg
                radius: 2,
                fillKey: 'OFFICE',
                latitude: 19.4301372,
                longitude: -99.17133,
                borderWidth: 0
            }
        ];

        var map;

        function draw() {
            map = new window.Datamap({
                element: document.getElementById('container'),
                fills: {
                    OK: '#0e97dd',
                    CLOSED: '#400000',
                    OFFICE: '#ffffff',
                    defaultFill: '#000000'
                },
                geographyConfig: {
                    highlightOnHover: false,
                    popupOnHover: false,
                    borderColor: '#14517a'
                },
                projection: 'mercator'
            });

            map.bubbles(offices);
        }

        function getHour(time) {
            return parseInt(time.substr(0, 2));
        }

        function getMinute(time) {
            return parseInt(time.substr(3, 2));
        }

        function pad(num) {
            var ret = '' + num;
            if (ret.length === 1) {
                return '0' + num;
            }
            return num;
        }

        function formatSeconds(seconds) {
            return pad(Math.floor(seconds / 3600)) +
                ':' +
                pad(Math.floor(seconds % 3600 / 60)) +
                '.' +
                pad(seconds % 60);
        }

        function displayCountry(country) {
            switch (country) {
                case 'AUS':
                    return 'AU';
                case 'DNK':
                    return 'DK';
                case 'ESP':
                    return 'ES';
                case 'FRA':
                    return 'FR';
                case 'IRL':
                    return 'IE';
                case 'ITA':
                    return 'IT';
                case 'NOR':
                    return 'NO';
                case 'NZL':
                    return 'NZ';
                default:
                    return 'UK';
            }
        }

        function init() {
            for (var i = 0; i < countries.length; i++) {
                var div = document.createElement('div');
                div.setAttribute('class', 'country');
                div.setAttribute('id', countries[i]);
                document.getElementById('info').appendChild(div);

                div.innerHTML = '<pre> <span style="color: #19a7e9;">' + displayCountry(countries[i]) + '</pre><pre></pre>';
            }
        }

        function formatTime(time, country) {
            var zone;
            switch (country) {
                case 'AUS':
                    zone = 'Australia/Sydney';
                    break;
                case 'DNK':
                    zone = 'Europe/Copenhagen';
                    break;
                case 'ESP':
                    zone = 'Europe/Madrid';
                    break;
                case 'FRA':
                    zone = 'Europe/Paris';
                    break;
                case 'ITA':
                    zone = 'Europe/Rome';
                    break;
                case 'NOR':
                    zone = 'Europe/Oslo';
                    break;
                case 'NZL':
                    zone = 'Pacific/Auckland';
                    break;
                default:
                    zone = 'Europe/London';
                    break;
            }

            var m = window.moment(time);

            return m.tz(zone).format('HH:mm A');
        }

        function update() {
            var openCountries = [];

            var info = [];

            var utc = new Date();

            var day = utc.getDay();

            var dayWindows = windows[day];

            var now = utc.getUTCHours() * 3600 + utc.getUTCMinutes() * 60 + utc.getSeconds();

            var i, start, slot;

            for (i = 0; i < dayWindows.length; i++) {
                slot = dayWindows[i];

                start = getHour(slot.start) * 3600 + getMinute(slot.start) * 60;
                var end = getHour(slot.end) * 3600 + getMinute(slot.end) * 60;

                if (now >= start && now <= end) {
                    map.updateChoropleth(JSON.parse('{ "' + slot.country + '": { "fillKey": "OK" }}'));
                    info.push(JSON.parse(' { "country": "' +
                        slot.country +
                        '", "remaining": ' +
                        (end - now) +
                        ' }'));
                    if (!openCountries.includes(slot.country)) {
                        openCountries.push(slot.country);
                    }
                }
            }

            var div;

            for (i = 0; i < countries.length; i++) {
                if (!openCountries.includes(countries[i])) {
                    map.updateChoropleth(JSON.parse('{ "' + countries[i] + '": { "fillKey": "CLOSED" }}'));
                }
            }

            for (i = 0; i < countries.length; i++) {
                div = document.getElementById(countries[i]);
                if (div) {
                    div.children[1].innerHTML = '';
                }
            }

            var pre;

            for (i = 0; i < info.length; i++) {
                var detail = info[i];

                div = document.getElementById(detail.country);

                pre = div.children[1].innerHTML;
                var color = '#00e800';
                if (detail.remaining < 600) {
                    var g = Math.floor((232 / 600) * detail.remaining);
                    var r = 232 - g;
                    color = '#' + pad(r.toString(16)) + pad(g.toString(16)) + '00';
                }
                pre = pre + '<span style="color: ' + color + ';"> ' + formatSeconds(detail.remaining) + '</span>\n';
                div.children[1].innerHTML = pre;
            }

            var country;

            for (i = 0; i < countries.length; i++) {
                country = countries[i];

                if (!openCountries.includes(country)) {
                    div = document.getElementById(country);

                    var next = 0;

                    var x;

                    dayWindows = windows[day];
                    for (x = 0; x < dayWindows.length; x++) {
                        slot = dayWindows[x];
                        if (slot.country === country) {
                            start = getHour(slot.start) * 3600 + getMinute(slot.start) * 60;

                            if (start > now) {
                                next = start - now;
                            }
                        }
                    }

                    if (next === 0) {
                        next = 86400 - now;

                        loop1:
                        for (var d = day + 1; d < day + 7; d++) {
                            dayWindows = windows[d % 7];

                            loop2:
                            for (x = 0; x < dayWindows.length; x++) {
                                slot = dayWindows[x];
                                if (slot.country === country) {
                                    start = getHour(slot.start) * 3600 + getMinute(slot.start) * 60;

                                    next += start;
                                    break loop1;
                                }
                            }

                            next += 86400;
                        }
                    }

                    pre = div.children[1].innerHTML;
                    if (next === 2147483647) {
                        pre = pre + '<span style="color: #e80000;"> ?</span>\n';
                    } else {
                        pre = pre + '<span style="color: #e80000;">-' + formatSeconds(next) + '</span>\n';
                    }
                    div.children[1].innerHTML = pre;
                }
            }

            for (i = 0; i < countries.length; i++) {
                country = countries[i];

                div = document.getElementById(country);
                pre = div.children[1].innerHTML;
                pre = pre + '\n<span style="color: #19a7e9;"> ' + formatTime(utc, country) + '</span>\n';
                div.children[1].innerHTML = pre;
            }

            var middayLine = document.getElementById('time');
            var left = (window.innerWidth / 86400) * now;
            middayLine.setAttribute("style", "left: " + left + 'px;');

            var beerLine = document.getElementById('beer');
            left = ((window.innerWidth / 86400) * (now - 18000)) % window.innerWidth;
            console.log(left);
            beerLine.setAttribute("style", "left: " + left + 'px;');

            var alarmLine = document.getElementById('alarm');
            left = ((window.innerWidth / 86400) * (now + 18000)) % window.innerWidth;
            console.log(left);
            alarmLine.setAttribute("style", "left: " + left + 'px;');
        }

        draw();

        init();

        update();

        setInterval(update, 500);

        var scan = 0;

        function updateScan() {
            var scanLine = document.getElementById('scan');
            scanLine.setAttribute("style", "top: " + scan + "px;");
            scan++;
            if (scan > window.innerHeight) {
                scan = 0;
            }
        }

        setInterval(updateScan, 1);
    </script>
</body>
</html>