<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Release Window Map</title>
    <script src="scripts/d3.min.js"></script>
    <script src="scripts/topojson.min.js"></script>
    <script src="scripts/datamaps.world.hires.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #131313;
            font-family: "Lucida Console", Monaco, monospace;
            overflow-x: hidden;
            overflow-y: hidden;
        }
        div.info {
            position: absolute;
            padding: 2px 4px;
            left: 5%;
            top: 80%;
            display: flex;
            flex-wrap: wrap;
        }
        div.country {
            color: #00e800;
            display: flexbox;
            margin-right: 20px;
        }
        pre {
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="container" style="width: 100%; height: 100vh;"></div>
    <div class="info" id="info"></div>
    <script>
        var countries = ['GBR', 'AUS'];

        var windows = [
            [], [], [],
            [
                // Wednesday
                {
                    start: '03:00',
                    end: '23:00',
                    country: 'GBR',
                    environment: 'PROD'
                },
                {
                    start: '09:30',
                    end: '23:45',
                    country: 'GBR',
                    environment: 'TEST'
                },
                {
                    start: '11:08',
                    end: '11:13',
                    country: 'AUS',
                    environment: 'PROD'
                }
            ]
        ];

        var map = new Datamap({
            element: document.getElementById('container'),
            fills: {
                OK: '#0e97dd',
                defaultFill: '#000000'
            },
            geographyConfig: {
                highlightOnHover: false,
                popupOnHover: false,
                borderColor: '#14517a'
            },
            projection: 'mercator'
        });

        function getHour(time) {
            return parseInt(time.substr(0, 2));
        }

        function getMinute(time) {
            return parseInt(time.substr(3, 2));
        }

        function pad(num) {
            var ret = '' + num;
            if (ret.length === 1) {
                return '0' + num;
            }
            return num;
        }

        function formatRemaining(remaining) {
            return pad(Math.floor(remaining / 3600)) +
                ':' +
                pad(Math.floor(remaining % 3600 / 60)) +
                '.' +
                pad(remaining % 60);
        }

        function update() {
            var openCountries = [];

            var info = [];

            var utc = new Date();

            var day = utc.getDay();

            var dayWindows = windows[day];

            var i;

            for (i = 0; i < dayWindows.length; i++) {
                var slot = dayWindows[i];

                var start = getHour(slot.start) * 3600 + getMinute(slot.start) * 60;
                var end = getHour(slot.end) * 3600 + getMinute(slot.end) * 60;
                var now = utc.getUTCHours() * 3600 + utc.getUTCMinutes() * 60 + utc.getSeconds();

                if (now >= start && now <= end) {
                    map.updateChoropleth(JSON.parse('{ "' + slot.country + '": { "fillKey": "OK" }}'));
                    info.push(JSON.parse(' { "country": "' +
                        slot.country +
                        '", "environment": "' +
                        slot.environment +
                        '", "remaining": ' +
                        (end - now) +
                        ' }'));
                    if (!openCountries.includes(slot.country)) {
                        openCountries.push(slot.country);
                    }
                }
            }

            var div;

            for (i = 0; i < countries.length; i++) {
                if (!openCountries.includes(countries[i])) {
                    map.updateChoropleth(JSON.parse('{ "' + countries[i] + '": { "fillKey": "" }}'));
                    div = document.getElementById(countries[i]);
                    if (div) {
                        div.parentNode.removeChild(div);
                    }
                }
            }

            for (i = 0; i < countries.length; i++) {
                div = document.getElementById(countries[i]);
                if (div) {
                    div.children[1].innerHTML = '';
                }
            }

            for (i = 0; i < info.length; i++) {
                var detail = info[i];

                div = document.getElementById(detail.country);
                if (!div) {
                    div = document.createElement('div');
                    div.setAttribute('class', 'country');
                    div.setAttribute('id', detail.country);
                    document.getElementById('info').appendChild(div);

                    div.innerHTML = '<pre>' + detail.country + '</pre><pre></pre>';
                }

                var pre = div.children[1].innerHTML;
                var env = detail.environment;
                while (env.length < 7) {
                    env += ' ';
                }
                var color = '#00e800';
                if (detail.remaining < 1800) {
                    var g = Math.floor((232 / 1800) * detail.remaining);
                    var r = 232 - g;
                    color = '#' + pad(r.toString(16)) + pad(g.toString(16)) + '00';
                }
                pre = pre + '<span style="color: ' + color + ';">' + env + formatRemaining(detail.remaining) + '</span>\n';
                div.children[1].innerHTML = pre;
            }
        }

        update();

        setInterval(update, 1000);
    </script>
</body>
</html>